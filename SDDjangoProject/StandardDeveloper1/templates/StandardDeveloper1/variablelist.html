<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">

{% load static %}
<head>
	{% include 'StandardDeveloper1/head.html' %}
 
 <script>
	
	$(document).ready(function(){
		var chosenvar; 
		// If a new variable is being defined from a standard variable chosen from a dropdown menu 
		$('#navtabul').on('click','.dropdown-menu li>a',function(){
			$('[name=CustomYN]').val(false) ;

			var chosenvar = $(this).text() ;
			var DSName = "{{DSName}}" ;

			// Store in a hidden variable
			$('[name=MD]').val(JSON.stringify({'Name':chosenvar})) ;

			// Put into modal header
			$('#mh4').text('Variable metadata: '+chosenvar) ;

			$('[name=Action]').val('Add');

			if (DSName == 'ADSL') {
				DisplaySource1() ;
				$('#mf').append('<input type="button" class="btn btn-success" value="Next"/>');
			}
			else {
				DisplayVLMYN() ;
				$('#mf').append('<input type="button" class="btn btn-success" value="Next" id="ToSource1FromVLMYN"/>');
			}

			// Show the modal that asks if the variable will be defined with VLM
			$('#myModal').modal() ;

		})

		// If a new custom variable is being defined
		$('#navtabul').on('click','#customvar',function() {
			var DSName = "{{DSName}}" ;
			$('[name=CustomYN]').val(true) ;
			$('#mb').append('<div class="form-group"><label>Making up a new variable?  What do you want to call it?</label><input type="text" id="customvarname" class="form-control"></div>') ;

			$('[name=Action]').val('Add');

			$('#mf').append('<input type="button" class="btn btn-success" value="Next" id="ProcessCustom"/>');

			// Show the modal that asks if the variable will be defined with VLM
			$('#myModal').modal('show') ;
		})

		// Process custom variable
		$('#myModal').on('click','#ProcessCustom',function() {
			$('[name=MD]').val(JSON.stringify({Name:$('#customvarname').val()})) ;
			$('#mh4').text('Variable metadata: '+$('#customvarname').val()) ;
			$('#mb').empty();

			var DSName=$('[name=DSName]').val() ;

			if (DSName == 'ADSL') {
				DisplaySource1() ;
			}
			else {
				DisplayVLMYN() ;
				$('[value=Next').attr('id','ToSource1FromVLMYN') ;
			}
		})

		// Handler for when a user wants to edit a variable

		// First determine which variable was chosen
		$('.container').on('click','.EditVarFromVar',function() {
			var rowindex=$(this).closest('tr').data('index'); 
			var chosenvar=$('#varmdtable').bootstrapTable('getData')[rowindex]['VarName'] ;
			var VLMTF=$('#varmdtable').bootstrapTable('getData')[rowindex]['VLMTF'] ;
			var Origin=$('#varmdtable').bootstrapTable('getData')[rowindex]['Origin'] ;

			$('[name=CustomYN]').val($('#varmdtable').bootstrapTable('getData')[rowindex]['CustomTF']) ;
			$('[name=MD1]').val(JSON.stringify({'Name':chosenvar,'Origin':Origin})) ;
			$('[name=MD]').val(JSON.stringify({'Name':chosenvar})) ;
			$('[name=Action]').val('Edit');

			// Store method information
			$.getJSON($('[name=URLPath]').val()+'GetStudyVarMethod',{'Study':$('[name=Study]').val(),'DSName':$('[name=DSName]').val(),'VarName':chosenvar,'VLMOID':''},function(data) {
				$('#hidemodal').append('<input type="hidden" name="methodchoice" value="'+data[0]['methodchoice'] +'"/>') ;

				if (data[0]['Description'] != '') {
					$('[name=Method1]').val(JSON.stringify({'MethodType':'FreeText','MethodValue':data[0]['Description']})) ;
				}

				else {
					var MethodList=[]
					$.each(data,function() {
						MethodList.push({'Condition':this['If'],'Result':this['Then']})
					})
					$('[name=Method1]').val(JSON.stringify({'MethodType':'Conditions','MethodValue':MethodList})) ;
				}
			})

			if (VLMTF) {
				DisplayVarMD4VLM("{{Study}}","{{StandardName}}","{{StandardVersion}}","{{DSName}}",chosenvar,"Study")
				$('#mf').append('<input type="button" class="btn btn-success" value="Next" id="ToCommentFromVLM"/>');
			}

			else {
				DisplaySource1(Origin) ;
				$('#mf').append('<input type="button" class="btn btn-success" value="Next"/>');
				$('[name=Origin]').change() ;
			}

			// Put into modal header
			$('#mh4').text('Variable metadata: '+chosenvar) ;

			$('#myModal').modal() ;
		})


		// When the VLM question is answered...
		$('#myModal').on('click','[id^=ToSource1]',function(){
			var id=$(this).attr('id') ;
			var IGDSource=$('[name=IGDSource]').val() ;
			var CustomYN=$('[name=CustomYN]').val() ;

			var MDDic=JSON.parse($('[name=MD]').val()) ;
			var VarName=MDDic['Name']

			// If coming from VLM question ... 
			if (id.substr(9,9) == 'FromVLMYN') {
				// Determine which choice was selected
				var VLM=$("input[name=vlmYN]:checked").val() ;
				$('#mb').empty() ;
				if (VLM == 'Y'){
					if (CustomYN == 'true') {
						DisplayVarMD4VLM("{{Study}}","{{StandardName}}","{{StandardVersion}}","{{DSName}}",VarName,"")
					}

					else if (IGDSource == 'Model') {
						DisplayVarMD4VLM("{{Study}}","{{StandardName}}","{{StandardVersion}}","{{Class}}",VarName,"Model")
					}

					else if (IGDSource == 'Standard') {
						DisplayVarMD4VLM("{{Study}}","{{StandardName}}","{{StandardVersion}}","{{DSName}}",VarName,"Standard")
					}

					$('#'+id).attr('id','ToCommentFromVLM') ;
				}

				else {
					DisplaySource1() ;
				}
			}
		})

		// When Origin is chosen, change the ID of the button
		$('#myModal').on('change','[name=Origin]',function(){
			if ($('[name=Origin] :selected').text() == 'Assigned') {
				$('.btn').attr('id','ToVarmdFromSource1') ;
			}
			else {
				$('.btn').attr('id','ToSource2FromSource1') ;
			}
		})

		// When the Variable-level Source question is answered...
		$('#myModal').on('click','[id^=ToSource2]',function(){
			var id=$(this).attr('id') ;
			var Action=$('[name=Action').val() ;

			if (id == 'ToSource2FromSource1') {
				// Determine which Origin choice was selected
				var Origin=$('[name=Origin] :selected').val() ;
				// Pass this on to a hidden variable for access later
				var MDDic=JSON.parse($('[name=MD]').val()) ;
				MDDic['Origin']=Origin ;
				$('[name=MD]').val(JSON.stringify(MDDic)) ;
				//$('#hide').append('<input type="hidden" name="PredYN" value="'+(Pred == "Y")+'"/>') ;
				$('#mb').empty();

				if (Action == 'Edit') {
					var MD1Dic=JSON.parse($('[name=MD1]').val()) ;
					var Var1=MD1Dic['Name'] ;
					var Origin1=MD1Dic['Origin']
				}

				// If a predecessor, get source info about predecessor
				if (Origin == 'Predecessor') {
					if (Action == 'Add' || Origin1 != 'Predecessor') {
						DisplaySourcePredecessor() ;
					}
					else {
						DisplaySourcePredecessor(Var=Var1) ;
						$('#PredTable').on('load-success.bs.table',function(e) {
							var currentsources=$('#PredTable').bootstrapTable('getSelections') ;
							$('[name=Sources1]').val(JSON.stringify(currentsources)) ;
							if (currentsources.length) {
								$('#c1').prop('checked',true) ;
							}
						})
					}

					$(this).attr('id','ToPredVarFromPredSource') ;
					
				}

				else {
					if (Action == 'Add' || Origin1 == 'Predecessor') {
						DisplaySourceDerived() ;
					}
					else {
						DisplaySourceDerived(Var=Var1) ;
						$('#SourceTable').on('load-success.bs.table',function(e) {
							var currentsources=$('#SourceTable').bootstrapTable('getSelections') ;
							$('[name=Sources1]').val(JSON.stringify(currentsources)) ;
						})
					}

					$(this).attr('id','ToVarmdFromDerivedSource') ;
				}

			}
		})


		// When the Next button is clicked from choosing a predecessor source
		$('#myModal').on('click','[id^=ToPredVar]',function(){
			//$('#varpredsourcebutton').attr('id','varpredsourcevarbutton') ;
			var id=$(this).attr('id') ;
			if (id == "ToPredVarFromPredSource") {
			// Determine whether user chose to select a pre-defined source (c1), to define a new ADaM source (c2), or define a new SDTM source (c3), and save this choice in a hidden variable
				var predsource=$('[name=sourcetype]:checked').attr('id') ;
				$('#hide').append('<input type="hidden" name="predsource" value="'+predsource+'"/>') ;

				// If user chose a pre-defined source
				if (predsource == 'c1') {
					// Determine which row was selected (particularly, if the first row, which has the record sources, was chosen)
					var SourceDic=$('#PredTable').bootstrapTable('getSelections')[0] ;
					var RecordSourceYN=SourceDic['RecordSourceYN'] ;
					$('#mb').empty() ;
					DisplayPredVarPreDefined(SourceDic,RecordSourceYN) ;
				}

				// Else if user chose to define a new SDTM source
				else if (predsource == 'c3') {
					$('#mb').empty() ;
					DisplayPredVarSDTM() ;
					SourceDic={'Models':'SDTM'} ;
				}

				// User chose to define a new ADaM source
				else if (predsource == 'c2') {
					$('#mb').empty() ;
					DisplayPredVarADAM($('[name=DSName]').val()) ;
					SourceDic={'Models':'ADAM'} ;
				}

				$('#ToPredVarFromPredSource').attr('id','ToVarmdFromPredVar') ;
				$('[name=Sources]').val(JSON.stringify([SourceDic])) ;
			}
		})


		$('#myModal').on('click','[id^=ToVarmd]',function() {
			var id=$(this).attr('id') ;
			var MDDic=JSON.parse($('[name=MD]').val()) ;

			if (id == 'ToVarmdFromPredVar') {
				// Start by collecting the predecessor variable information and storing in Sources hidden variable
				var predsource = $('[name=predsource]').val() ;
				var SourceObj = JSON.parse($('[name=Sources]').val()) ;
				var SourceDic = SourceObj[0] ;

				if (predsource == 'c1') {
					var DatasetList = SourceDic['Datasets'] ;
					var VarList = [] ;
					var method='Copy ' ;
					for (x=0; x<DatasetList.length; x++) {
						VarList.push($('#var_'+DatasetList[x]).val()) ;
						if (x>0) {
							method += ', ' ;
						}
						method += DatasetList[x]+"."+$('#var_'+DatasetList[x]).val() ;
					}

					// Store the method in hidden variable
					$('[name=Method]').val(JSON.stringify({MethodType:"FreeText",MethodValue:method})); 

					SourceDic['Vars'] = VarList ;
				}

				else if (predsource == 'c2') {
					SourceDic['Vars'] = $('#adamvar').val() ;
					SourceDic['Datasets'] = $('#adamds').val() ;
					SourceDic['Subsets'] = $('#adamsubset').val() ;
					SourceDic['JConditions'] = $('#adamjoin').val() ;
					$('[name=Method]').val(JSON.stringify({MethodType:"FreeText",MethodValue:'Copy '+$('#adamds').val()+'.'+$('#adamvar').val()})); 
				}

				else if (predsource == 'c3') {
					SourceDic['Vars'] = $('#sdtmvar').val() ;
					SourceDic['Datasets'] = $('#sdtmds').val() ;
					SourceDic['Subsets'] = $('#sdtmsubset').val() ;
					SourceDic['JConditions'] = $('#sdtmjoin').val() ;
					$('[name=Method]').val(JSON.stringify({MethodType:"FreeText",MethodValue:'Copy '+$('#sdtmds').val()+'.'+$('#sdtmvar').val()})); 
				}

				$('[name=Sources]').val(JSON.stringify([SourceDic])) ;
			}

			else if (id == 'ToVarmdFromDerivedSource') {
				// Collect source information and store in hidden variable
				$('[name=Sources]').val(JSON.stringify($('#SourceTable').bootstrapTable('getSelections'))) ;
			}

			else if (id == 'ToVarmdFromSource1') {
				MDDic['Origin']=$('[name=Origin] :selected').val() ;
				$('[name=MD]').val(JSON.stringify(MDDic)) ;
			}

			// Then form the parameters to the DisplayVarMD function, and then call it
			$('#mb').empty() ;
			//$('#varpredsourcevarbutton').attr('id','varmd') ;
			var Action=$('[name=Action]').val() ;
			var IGDSource=$('[name=IGDSource]').val() ;
			var CustomYN=$('[name=CustomYN]').val() ;
			var VarName=MDDic['Name'] ;

			if (Action == 'Edit') {
				DisplayVarMD("{{Study}}","{{StandardName}}","{{StandardVersion}}","{{DSName}}",VarName,"Study")
			}

			else if (CustomYN == 'true') {
				DisplayVarMD("{{Study}}","{{StandardName}}","{{StandardVersion}}","{{DSName}}",VarName,"")
			}

			else if (IGDSource == 'Model') {
				DisplayVarMD("{{Study}}","{{StandardName}}","{{StandardVersion}}","{{Class}}",VarName,"Model")
			}

			else if (IGDSource == 'Standard') {
				DisplayVarMD("{{Study}}","{{StandardName}}","{{StandardVersion}}","{{DSName}}",VarName,"Standard")
			}

			$(this).attr('id','ToCT1FromVarmd') ;
		})




		// Once the variable metadata has been defined, move on to controlled terminology
		$('#myModal').on('click','[id^=ToCT1]',function() {
			var Action=$('[name=Action').val() ;
			var CustomYN=$('[name=CustomYN]').val() ;
			var id=$(this).attr('id') ;
			var mddic=JSON.parse($('[name=MD]').val()) ;

			if (id == 'ToCT1FromVarmd') {
				// Store variable-level metadata

				if (CustomYN == 'true') {
					mddic['Label']=$('[name=VarLabel]').val() ;
					mddic['SASType']=$('[name=VarSASType]').val() ;
				}

				mddic['SASLength']=$('[name=VarSASLength]').val() ;
				mddic['DataType']=$('[name=VarDataType]').val() ;
				mddic['OrderNumber']=$('[name=VarOrderNumber]').val() ;
				mddic['Mandatory']=$('[name=VarMandatory]').val() ;

				$('[name=MD]').val(JSON.stringify(mddic)) ;
			}

			// This determines whether or not a standard codelist is associated with a variable
			var StandardCL=$('[name=StandardCTName]').val() ;

			$('#mb').empty() ;

			if (Action == "Add") {
				// If a standard codelist is associated with the variable, then give a choice of base codelists to start with, and if not a predecessor, if the user wants to define it with the method
				if (StandardCL) {
					DisplayCTStandard(StandardCL) ;
					//$('#'+id).attr('id','ct1') ;
					$('#'+id).attr('id','ToACodeListFromCTStandard')
				}

				else {
					DisplayCTCustom() ;
					$('#'+id).attr('id','ToListofCodeListsFromCTCustom') ;
				}
			}

			else {
				var StudyCT=$('[name=CT1]').val();
				var mddic=JSON.parse($('[name=MD]').val()) ;
				var methodchoice=$('[name=methodchoice]').val() ;

				if (StandardCL && StudyCT) {
					if (methodchoice == 'b' || mddic['Origin'] == 'Predecessor') {
						DisplayACodeList("Get1StudyWStandardCodeList",{Study:$('[name=Study]').val(),CLCode:$('[name=CTCode]').val(),StudyCLName:StudyCT,StandardCLName:StandardCL},$('[name=CTExt]').val() ,$('[name=CTDecodeYN]').val()) ;
						$('#'+id).attr('id','ToCTSummaryFromACodeList') ;
						$('[name=CT]').val(JSON.stringify({'Code':$('[name=CTCode]').val(),'Extensible':$('[name=CTExt]').val(),'DataType':mddic['DataType']})) ;
					}
				}

				else if (StudyCT) {
					DisplayACodeList('Get1StudyCodeList',{Study:$('[name=Study]').val(),CLCode:'',StudyCLName:StudyCT},$('[name=CTExt]').val() ,$('[name=CTDecodeYN]').val())
					$('#'+id).attr('id','ToCTSummaryFromACodeList') ;
					$('[name=CT]').val(JSON.stringify({'Code':$('[name=CTCode]').val(),'Extensible':$('[name=CTExt]').val(),'DataType':mddic['DataType']})) ;
				}

				else {
					DisplayCTCustom() ;
					$('#'+id).attr('id','ToListofCodeListsFromCTCustom') ;
				}

			}
		})

		// Now that a base codelist has been chosen, display its terms
		$('#myModal').on('click','[id^=ToACodeList]',function() {
			var id=$(this).attr('id') ;
			var Action=$('[name=Action').val() ;
			var StandardCL=$('[name=StandardCTName]').val() ;
			var CodeCL=$('[name=CTCode]').val() ;
			var mddic=JSON.parse($('[name=MD]').val()) ;

			if (id == 'ToACodeListFromCTStandard') {
				// Use the global list as a base
				if ($('#stdct2 :selected').val() == 'global') {
					var url='Get1GlobalCodeList';
					//var qp=function() {return {CLCode:CodeCL,StandardCLName:StandardCL} ;}
					var qp={CLCode:CodeCL,StandardCLName:StandardCL} ;
				}

				// Use any study list that has been defined as a subset of the global list as a base, along with the standard list itself
				else {
					var url='Get1StudyWStandardCodeList' ;
					var qp={Study:$('[name=Study]').val(),CLCode:CodeCL,StudyCLName:$('#stdct2 :selected').text(),StandardCLName:StandardCL}; 
				}

				if (mddic['Origin'] != 'Predecessor') {
					var methodchoice = $('#stdct1 :selected').val().substr(6,1); ;
					$('#hide').append('<input type="hidden" name="methodchoice" value="'+methodchoice +'"/>') ;
				}

				// Store Codelist-level properties (except Name, we'll save that for later)
				var Ext = $('[name=CTExt]').val() ;
				var DecodeYN=($('[name=CTDecodeYN]').val() == 'true') ;
				$('[name=CT]').val(JSON.stringify({'Code':$('[name=CTCode]').val(),'Extensible':Ext,'DataType':mddic['DataType']})) ;
			}

			else if (id == 'ToACodeListFromListofCodeLists') {
				var methodchoice=$('[name=methodchoice]').val() ;
				var codelistchoice=$('[name=codelistchoice]').val(); 

				// If user chose to create a codelist from an existing global or study codelist, then collect information from that codelist
				var CodeListDic=$('#CodeListTable').bootstrapTable('getSelections')[0] ;
				var Ext = CodeListDic['Extensible'] ;
				var DecodeYN = CodeListDic['DecodeYN'] ;
				// Store Codelist-level properties (except Name, we'll save that for later)
				$('[name=CT]').val(JSON.stringify({'Code':CodeListDic['CLCode'],'Extensible':Ext,'DataType':CodeListDic['DataType']})) ;

				// Use a global list as a base
				if (codelistchoice == 'a') {
					var url='Get1GlobalCodeList';
					var qp={CLCode:CodeListDic['CLCode'],StandardCLName:CodeListDic['CodeListName']} ;
					$('[name=StandardCTName]').val(CodeListDic['CodeListName']);
					$('[name=CTCode]').val(CodeListDic['CLCode']) ;
				}

				// Use any study list as a base
				else if (codelistchoice == 'b') {
					var url='Get1StudyCodeList';
					var qp={Study:"{{Study}}",CLCode:CodeListDic['CLCode'],StudyCLName:CodeListDic['CodeListName']} ;
				}
			}

			$('#mb').empty();
			if (methodchoice == 'b' || mddic['Origin'] == 'Predecessor') {
				DisplayACodeList(url,qp,Ext,DecodeYN) ;
				$('#'+id).attr('id','ToCTSummaryFromACodeList') ;
			}
		})


		// Once a codelist has been defined, see if it matches other study codelists or the global codelist off of which it is based.  If not, ask the user for a new codelist name
		$('#myModal').on('click','[id^=ToCTSummary]',function() {
			var id = $(this).attr('id');
			var StandardCL=$('[name=StandardCTName]').val();
			var StandardCode=$('[name=CTCode]').val() ;
			var mddic=JSON.parse($('[name=MD]').val()) ;
			var PredYN=(mddic['Origin'] == 'Predecessor') ;

			// Collect all the terms from the table
			TermList=JSON.stringify($('#CodeListItemTable').bootstrapTable('getSelections')) ;

			// Determine if the newly defined codelist already exists
			$.getJSON($('[name=URLPath]').val()+'CompareCT',{'Study':$('[name=Study]').val(),'StandardCLName':StandardCL,'StandardCode':StandardCode,'CT':TermList},function(data) {
				// Get what is already in the CT hidden variable and add to it
				var CTDic=JSON.parse($('[name=CT]').val()) ;
				CTDic['Match']=data['Match'] ;
				CTDic['MatchType']=data['MatchType'] ;
				
				if (data['Match']) {
					$('#mb').empty();

					if (PredYN) {
						$('#'+id).attr('id','ToCommentFromMatchCT');
					}
					else {
						$('#'+id).attr('id','ToMethodbFromMatchCT');
					}

					if (data['MatchType'] == 'Study') {
						if (data['Code']) {
							$('#mb').append('<p>NOTE: The codelist you have defined matches the following study-defined codelist: </p><p>'+data['Name']+' ('+data['Code']+')</p>')
						}

						else {
							$('#mb').append('<p>NOTE: The codelist you have defined matches the following study-defined codelist: </p><p>'+data['Name']+'</p>')
						}
					}

					else {
						$('#mb').append('<p>NOTE: You have chosen the following global codelist: </p><p>'+data['Name']+' ('+data['Code']+')</p>')
					}

					CTDic['Name']=data['Name'] ;
				}

				else {
					CTDic['CT']=$('#CodeListItemTable').bootstrapTable('getSelections') ;
					$('#mb').empty();

					if (PredYN) {
						$('#'+id).attr('id','ToCommentFromNoMatchCT');
					}
					else {
						$('#'+id).attr('id','ToMethodbFromNoMatchCT');
					}

					$('#mb').append('<p>The codelist you have defined is new to this study.  Please provide a name for this new codelist.</p><div class="form-group"><label>New Codelist name</label><input type="text" id="newCodeListName" class="form-control"/></div>') ;
					if (data['Name']) {
						$('#mb').append('<p>Name of global codelist off of which the current codelist is based: <b>'+data['Name']+'</b></p>') ;
					}
				}

				$('[name=CT]').val(JSON.stringify(CTDic)) ;
			})
		})




		$('#myModal').on('click','#ToBDSComment',function() {
			var alldata=$('#parmdtypes').bootstrapTable('getData') ;
			var dtypemethodslist=[] ;
			for (x=0; x<alldata.length; x++) {
				dtypemethoddic={'wcoid':alldata[x]['OID'],'method':$('[name=OID'+alldata[x]['OID']+']:checked').val(),'description':''}
				if ($('[name=OID'+alldata[x]['OID']+']:checked').val() == 'other') {
					dtypemethoddic['description'] = $('#desc'+alldata[x]['OID']).val() ;
				}
				dtypemethodslist.push(dtypemethoddic) ;
			}
			$('[name=DTYPEMethods]').val(JSON.stringify(dtypemethodslist)) ;
			$('#mb').empty() ;
			DisplayMethodComment(type='cvar') ;
			$('[id=ToBDSComment]').attr('id','ToFinalFromComment') ;
		})


		$('#myModal').on('click','[value=other]',function() {
			var rowindex=$(this).closest('tr').data('index'); 
			var rowdata=$('#parmdtypes').bootstrapTable('getData')[rowindex] ;
			$('#mb').append('<div class="form-group"><label>'+rowdata['Condition']+'</label><br/><textarea rows="2" cols="50" id="desc'+rowdata['OID']+'"></textarea></div>')
			// $('[name=rowdata]').val(JSON.stringify(rowdata));
			// $('#mh3').text(rowdata['Condition']) ;
			// if (rowdata['Description']) {
			// 	$('#desc').text(rowdata['Description']) ;
			// }
			// $('#myModal3').modal('show');
		})

		$('#donewithdesc').click(function() {
			var rowdata=JSON.parse($('[name=rowdata]').val()) ;
			rowdata['Description']=$('#desc').val() ;
			$('#parmdtypes').bootstrapTable('updateByUniqueId',{id:rowdata['OID'],row:rowdata}) ;
			//$('[name=OID'+rowdata['OID']+'][value=other]').prop('checked',true) ;
			$('#myModal3').modal('hide');
		})


		// When clicking on a row in the conditions table, add the condition/result to the row above it
		$('#myModal').on('click-row.bs.table','#ConditionTable',function(e,row,$el) {
			// This should only work when both a condition and a result are being added, not when the all else fails is added
			var ifelseradio=$('[name=ifelse]:checked').val() ;
			if (ifelseradio == 'if') {
				var idx=$el.data('index') ;
				if (idx == 0) {
					var ifelsetext='If';
				}
				else {
					var ifelsetext='Else if' ;
				}

				$('#ConditionTable').bootstrapTable('insertRow',{
					'index':idx,
					'row':{
						IfElse:ifelsetext,
						Condition:$('#condition').val(),
						Result:$('#result').val()
					}
				})

				$('#condition').val(null);
				$('#result').val(null);

				$('#ConditionTable').bootstrapTable('updateCell',{
					'index':idx+1,
					'field':'IfElse',
					'value':'Else if'
				})
			}
		})


		// Once a condition radio box is picked, enable text boxes
		$('#myModal').on('change','[name=ifelse]',function() {
			var ifelseradio=$('[name=ifelse]:checked').val() ;
			$('#result').prop('disabled',false);
			if (ifelseradio == 'if') {
				$('#condition').prop('disabled',false);
			}
		})

		// Insert one dropdown for the current variable group
		{% if VarGroup %}

		$.getJSON($('[name=URLPath]').val()+'GetStandardVarswoStudy',{'Study':$('[name=Study]').val(),'StandardName':$('[name=StandardName]').val(),'StandardVersion':$('[name=StandardVersion]').val(),'DSName':$('[name=DSName]').val(),'IGDSource':$('[name=IGDSource]').val(),'Class':$('[name=Class]').val(),'VarGroup':$('[name=VarGroup]').val()},function(data){
				$('#navtabul').append('<li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">{{VarGroup}} <span class="caret"></span></a><ul class="dropdown-menu" role="menu" id="dd"></ul></li>')

				$.each(data,function(){
					$('#dd').append('<li><a href="#myModal">'+this['Name']+'</a></li>')
				})

				{% if NextVarGroup %}
					$('#navtabul').append('<input type="submit" class="btn btn-default btn-success" formaction="ChangeVarGroup" style="float:right" value="Continue to {{NextVarGroup}}"/>')
				{% else %}
					$('#navtabul').append('<input type="submit" class="btn btn-default btn-success" formaction="ChangeVarGroup" style="float:right" value="Continue to All Variable Groups"/>')
				{% endif %}
		})

		{% else %}
		// Create the dropdown for each variable group
		$.getJSON($('[name=URLPath]').val()+'GetAllVarGroups',{'StandardName':$('[name=StandardName]').val(),'StandardVersion':$('[name=StandardVersion]').val(),'DSName':$('[name=DSName]').val(),'IGDSource':$('[name=IGDSource]').val(),'Class':$('[name=Class]').val()},function(data){

			$.each(data,function(){
				if (this['VarGroup']) {
					var ddid=this['VarGroup'].replace(/[^a-zA-Z]/g, '');
					$('#navtabul').append('<li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">'+this['VarGroup']+' <span class="caret"></span></a><ul class="dropdown-menu" role="menu" id="'+ddid+'"></ul></li>')
				}
			})
			$('#navtabul').append('<li><button type="button" class="btn btn-default btn-primary" id="customvar">Define a custom variable</button>&nbsp;')
			$('#navtabul').append('<li><input type="submit" class="btn btn-default btn-success" value="Finish"></input></li>')
		})

		// Now populate the dropdowns
		$.getJSON($('[name=URLPath]').val()+'GetStandardVarswoStudy',{'Study':$('[name=Study]').val(),'StandardName':$('[name=StandardName]').val(),'StandardVersion':$('[name=StandardVersion]').val(),'DSName':$('[name=DSName]').val(),'IGDSource':$('[name=IGDSource]').val(),'Class':$('[name=Class]').val(),'VarGroup':''},function(data){

			$.each(data,function(){
				if (this['VarGroup']) {
					var ddid=this['VarGroup'].replace(/[^a-zA-Z]/g, '');
					$('#'+ddid).append('<li><a href="#">'+this['Name']+'</a></li>')
				}
			})
		})
		{% endif %}
	})


</script>


</head>

<body style="font-family: 'Lora', serif;">

	{% include 'StandardDeveloper1/sidebar.html' %}

	{% include 'StandardDeveloper1/topbar.html' %}



<form method="post" action='Back2Study' id="parentform">
{% csrf_token %}

<div id="hide">
	<input type="hidden" name="StandardName" value="{{StandardName}}"/>
	<input type="hidden" name="Study" value="{{Study}}"/>
	<input type="hidden" name="StandardVersion" value="{{StandardVersion}}"/>
	<input type="hidden" name="DSName" value="{{DSName}}"/>
	<input type="hidden" name="IGDSource" value="{{IGDSource}}"/>
	<input type="hidden" name="VarGroup" value="{{VarGroup}}"/>
	<input type="hidden" name="Class" value="{{Class}}"/>
	<input type="hidden" name="NextVarGroup" value="{{NextVarGroup}}"/>
	<input type="hidden" name="URLPath" value="{{URLPATH}}"/>
</div>


<div class="container">
	<h2>Study: {{Study}}</h2>
	<h2>Variable Definitions for {{DSName}}</h2>
	<p id="Instruction">This page allows you to define variables.  We start by defining variables by variable groups.  After certain variable groups are defined, you will have a chance to define variables in other variable groups as well as custom variables.  Click the dropdown below to get started with the current variable group.  When finished click the button to move to the next variable group or to all groups.</p>
	<ul class="nav nav-tabs" id='navtabul'>
	</ul>

	<div class='im-centered'>
		<table data-toggle="table" id="varmdtable" data-id-field="name" data-url="{{URLPATH}}GetADaMStudyVars" data-query-params="StudySourceParms">
		    <thead>
		    <tr>
		    	<th data-field="OID" data-class="hidden"></th>
		        <th data-field="VarName">Name</th>
		        <th data-field="Label">Label</th>
		        <th data-field="SASType">SAS Type</th>
		        <th data-field="SASLength">SAS Length</th>
		        <th data-field="DataType">Data Type</th>
		        <th data-field="Origin">Origin</th>
		        <th data-field="VLMTF" data-class="hidden"/>
		        <th data-field="CustomTF" data-class="hidden"/>
		        <th data-field="removeedit" data-formatter="GlyphsRemoveEdit" data-align="center" data-class="EditVarFromVar">Action</th>
        	</tr>
		    </thead>
		</table>
	</div>
</div>
</form>

<div id="myModal" class="modal fade" role="dialog">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<form id="modalForm" action='NewVar' method="post" >
				{% csrf_token %}
				<div id="hidemodal">
					<input type="hidden" name="StandardName" value="{{StandardName}}"/>
					<input type="hidden" name="Study" value="{{Study}}"/>
					<input type="hidden" name="StandardVersion" value="{{StandardVersion}}"/>
					<input type="hidden" name="DSName" value="{{DSName}}"/>
					<input type="hidden" name="IGDSource" value="{{IGDSource}}"/>
					<input type="hidden" name="VarGroup" value="{{VarGroup}}"/>
					<input type="hidden" name="Class" value="{{Class}}"/>
					<input type="hidden" name="NextVarGroup" value="{{NextVarGroup}}"/>
					<input type="hidden" name="Action"/>
					<input type="hidden" name="CustomYN"/>
					<input type="hidden" name="CTCode"/>
					<input type="hidden" name="CTExt"/>
					<input type="hidden" name="CTDecodeYN"/>
					<input type="hidden" name="StandardCTName"/>
					<input type="hidden" name="StudyCTName"/>
					<input type="hidden" name="MD"/>
					<input type="hidden" name="Sources"/>
					<input type="hidden" name="CT"/>
					<input type="hidden" name="Method"/>
					<input type="hidden" name="Comment"/>
					<input type="hidden" name="DTYPEMethods"/>
					<input type="hidden" name="MD1"/>
					<input type="hidden" name="Sources1"/>
					<input type="hidden" name="CT1"/>
					<input type="hidden" name="Method1"/>
					<input type="hidden" name="Comment1"/>
					<input type="hidden" name="DTYPEMethods1"/>

				</div>
			    <div class="modal-header" id="mh">
			    	<button type="button" class="close" data-dismiss="modal">&times;</button>
			    	<h4 class="modal-title" id="mh4"></h4>
			    </div>

			    <div class="modal-body" id="mb">
			    </div>

	            <div class="modal-footer" id="mf">
	            </div>
        	</form>
		</div>
	</div>
</div>


<div class="modal fade" id="myModal3" role="dialog">
    <div class="modal-dialog" style="width: 300px;font-family: 'Lato', sans-serif;">

        <!-- Modal content-->
        <div class="modal-content" style="width: 300px;">
        	<div id="hide3">
        		<input type="hidden" name="rowdata"/>
        	</div>

            <div class="modal-header" style="width: 300px;">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="mh3"></h4>
            </div>

            <div class="modal-body" id="mb3" style="width: 300px;">
                <div class="container" id="mbc3" style="width: 300px;">
                	<textarea rows="3" cols="20" id="desc" placeholder="Enter Description here"></textarea>
					</div>
            </div>

            <div class="modal-footer" id="mf3" style="width: 300px;">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <input type="button" class="btn btn-success" value="Ok" id="donewithdesc"></input>
            </div>
        </div>

    </div>
</div>

{% include 'StandardDeveloper1/footer.html' %}

<script>

	function DisplayVLMYN() {
		$('#mb').append('<p>Will this variable be defined in subsets?</p><div class="radio"><label><input type="radio" name="vlmYN" value="Y">Yes</label></div><div class="radio"><label><input type="radio" value="N" name="vlmYN">No</label></div>');
	}

	function DisplaySource1(Origin='') {
		$('#mb').append('<p>We start by thinking about where this variable is coming from.  Is it copied from another variable?  Derived from another variable?  Does it come straight from the protocol?</p><div class="form-group"><select class="form-control" name="Origin"><option disabled selected></option><option value="Assigned">Assigned</option><option value="Protocol">Protocol</option><option value="Derived">Derived</option><option value="Predecessor">Predecessor</option></select></div>')

		if (Origin) {
			$('option[value='+Origin+']').prop('selected',true) ;
		}
	}

	function DisplayPredVarPreDefined(SourceDic,RSYN) {
		$('#mb').append('<p>In the box(es) below, provide the name of the variable in the source data set being mapped to this predecessor.</p>')
		if (RSYN == 'Y') {
			for (x=0; x<SourceDic['Datasets'].length; x++) {
				var desc = SourceDic['Models'][x]+'.'+SourceDic['Datasets'][x]
				if (SourceDic['Subsets'][x]) {
					desc += ' where '+SourceDic['Subsets'][x]
				}
				if (SourceDic['Models'][x] == 'SDTM') {
					$('#mb').append('<div class="form-group"><label>'+desc+'</label><input maxlength="8" id="var_'+SourceDic['Datasets'][x]+'" type="text" class="form-control"></div>');
				}
				else {
					$('#mb').append('<div class="form-group"><label>'+desc+'</label><select id="var_'+SourceDic['Datasets'][x]+'" class="form-control"></select></div>');
					$.getJSON($('[name=URLPath]').val()+'GetADaMStudyVars',{'Study':"{{Study}}",'DSName':"{{DSName}}"},function(data){
						$.each(data,function() {
							$('<option value="'+this['VarName']+'">'+this['VarName']+'</option>').appendTo('#var_'+SourceDic['Datasets'][x]);
						})
					})
				}
			}
		}

		else {
			var desc = SourceDic['Models']+'.'+SourceDic['Datasets']
			if (SourceDic['Subsets']) {
				desc += ' where '+SourceDic['Subsets']
			}
			if (SourceDic['Models'] == 'SDTM') {
				$('#mb').append('<div class="form-group"><label>'+desc+'</label><input maxlength="8" id="var_'+SourceDic['Datasets']+'" type="text" class="form-control"></div>');
			}
			else {
				$('#mb').append('<div class="form-group"><label>'+desc+'</label><select id="var_'+SourceDic['Datasets']+'" class="form-control"></select></div>');
				$.getJSON($('[name=URLPath]').val()+'GetADaMStudyVars',{'Study':"{{Study}}",'DSName':"{{DSName}}"},function(data){
					$.each(data,function() {
						$('<option value="'+this['VarName']+'">'+this['VarName']+'</option>').appendTo('#var_'+SourceDic['Datasets']);
					})
				})
			}
		}
	}

	function DisplayCTStandard(StandardCL) {

		var mddic=JSON.parse($('[name=MD]').val()) ;
		var Origin=mddic['Origin'] ;

		$('#mb').append("<p>It's now time to start thinking about how a programmer will populate this variable.  According to the standard, this variable is associated with a specific list of allowable values.  Complete the following information, and then click Next to define the allowable values that are relevant in this study.</p>") ;

		if (Origin != 'Predecessor') {
			$('#mb').append('<div><label>Choose here whether to define programming instructions along with allowable values or separate from allowable values.</label><div class="col-xs-4"><select class="form-control" id="stdct1"><option disabled selected></option><option value="stdct1a">Define allowable values with programming instructions</option><option value="stdct1b">Define allowable values separate from programming instructions</option></select></div></div>') ;
		}

		$('#mb').append('<div class="form-group"><label>Choose here which list of allowable values (global list or a sub-list defined in this study) on which your list will be based</label><select class="form-control" id="stdct2"><option disabled selected></option><option value="global">'+StandardCL+' (global)</option></select></div>') ;

		// Populate the above dropdown with study-specific sub-codelists
		$.getJSON($('[name=URLPath]').val()+'GetStudyCodelistsByCode',{'Study':$('[name=Study]').val(),'CLCode':$('[name=CTCode]').val()},function(data) {
			$.each(data,function() {
				$('#stdct2').append('<option>'+this['CLName']+'</option>') ;
			})
		})
	}



	function AddCondition() {
		// Determine if the result being added has a condition or not
		ElseFL=($('[name=ifelse]:checked').val() == "else") ;
		// Determine if the table has an Else row yet
		var AllData=$('#ConditionTable').bootstrapTable('getData') ;
		var ElseInTable=false; 
		for (x in AllData) {
			if (AllData[x]['IfElse'] == 'Else') {
				ElseInTable=true;
			}
		}
		var IfInTable=false; 
		for (x in AllData) {
			if (AllData[x]['IfElse'] == 'If') {
				IfInTable=true;
			}
		}

		// Insert data into the table
		if (ElseFL) {
			$('#ConditionTable').bootstrapTable('append',{
				IfElse:'Else',
				Result:$('#result').val() 
			})
			// Disable the Else radio button and check the If radio button
			$('[name=ifelse][value=else]').prop('disabled',true) ;
			$('[name=ifelse][value=if]').prop('checked',true) ;
			// Clear the Result text box
			$('#result').val(null) ;
			// Enable the Condition text box
			$('#condition').prop('disabled',false);
		}

		else {
			var cond=$('#condition').val() ;
			var res=$('#result').val() ;

			if (IfInTable) {
				var ei='Else if' ;
			}
			else {
				var ei='If';
			}
			if (ElseInTable) {
				$('#ConditionTable').bootstrapTable('insertRow',{
					'index':-1,
					'row':{
						IfElse:ei,
						Condition:cond,
						Result:res
					}
				})
			}

			else {
				$('#ConditionTable').bootstrapTable('append',{
					IfElse:ei,
					Condition:cond,
					Result:res
				})
				// Uncheck both radio buttons
				$('[name=ifelse][value=if]').prop('checked',false) ;
				$('[name=ifelse][value=else]').prop('checked',false) ;
				// Disable the boxes
				$('#condition').prop('disabled',true);
				$('#result').prop('disabled',true);
			}
			$('#condition').val(null);
			$('#result').val(null) ;
		}
	}


	function DisplayFinal(){
		$('#mb').append('<p>Your variable is complete!</p><br><input class="btn btn-success" type="submit" value="Finish" id="last"/>')
	}

	function DisplayPredVarSDTM() {
		$('#mb').append('<p>In the boxes below, provide information about the SDTM source</p><div class="row"><div class="col-xs-4 form-group"><label>SDTM data set name</label>\
			<input type="text" id="sdtmds" class="form-control"></div></div><div class="row"><div class="col-xs-4 form-group"><label>SDTM variable name</label>\
			<input type="text" id="sdtmvar" class="form-control"></div></div><div class="row"><div class="form-group col-xs-10"><label>Subset (optional)</label>\
			<input type="text" id="sdtmsubset" class="form-control" placeholder="e.g. LBTESTCD=ALB">\
			</div></div><div class="form-group"><label>Description of merge</label>\
			<textarea rows="3" cols="20" id="sdtmjoin" class="form-control"></textarea></div>') ;
	}

	function DisplayPredVarADAM(DSName) {
		$('#mb').append('<p>In the boxes below, provide information about the ADaM source</p><div class="form-group"><label>ADaM data set name</label><br/><select id="adamds" class-"form-control"><option disabled selected>Select ADaM data set</option></select></div>')
		$.getJSON($('[name=URLPath]').val()+'GetADaMStudyDS',{'Study':$('[name=Study]').val()},function(data) {
			$.each(data,function() {
				if (this['DSName'] != DSName) {
					$('<option value="'+this['DSName']+'">'+this['DSName']+'</option>').appendTo('#adamds') ;
				}
			})
		})
		$('#mb').append('<div class="form-group"><label>ADaM variable name</label><br/>\
			<select id="adamvar" class="form-control"></select></div><div class="row"><div class="form-group col-xs-10"><label>Subset (optional)</label>\
			<input type="text" id="adamsubset" class="form-control">\
			</div></div><div class="form-group"><label>Description of merge</label>\
			<textarea rows="3" cols="20" id="adamjoin" class="form-control"></textarea></div>') ;
	}


	function DisplayVarMD(Study,StandardName,StandardVersion,IGDName,VarNameIn,MDSource) {
		// MDSource can be Model, Standard, or Study, and determines where to go get the metadata from
		// If the user chose to define a new custom variable, then MDSource is null
		// If MDSource is Study, need to determine if the variable is custom or not (CustomYN)
		// CustomYN determines what is read-only 

		var VarName='',VarLabel='',VarSASType='',VarSASLength='',VarOrderNumber='',VarMandatory='',VarDataType='';
		var CustomYN=$('[name=CustomYN]').val() ;
		var MDDic=JSON.parse($('[name=MD]').val()) ;

		$('#mb').append('<div class="container"><div class="row" id="NameRow"><div class="col-xs-4">Name</div></div><div class="row" id="LabelRow"><div class="col-xs-4">Label</div></div><div class="row" id="SASTypeRow"><div class="col-xs-4">SAS Type</div></div><div class="row" id="SASLengthRow"><div class="col-xs-4">Length</div><div class="col-xs-8 form-group"><input type="number" min="1" max="200" name="VarSASLength"></div></div><div class="row" id="OrderNumberRow"><div class="col-xs-4">Dataset Position</div><div class="col-xs-8 form-group"><input type="number" min="1" max="200" name="VarOrderNumber"></div></div><div class="row" id="MandatoryRow"><div class="col-xs-4">Mandatory</div><div class="col-xs-8 form-group"><select name="VarMandatory"><option selected disabled></option><option value="No">No</option><option value="Yes">Yes</option></select></div></div><div class="row" id="DataTypeRow"><div class="col-xs-4">Data Type</div><div class="col-xs-8 form-group"><select name="VarDataType"><option selected disabled></option><option value= "text">text</option><option value="integer">integer</option><option value="float">float</option><option value="date">date</option><option value="datetime">datetime</option></select></div></div></div>') ;

		if (MDSource) {
			if (MDSource == 'Standard' || MDSource == 'Model') {
				var url=$('[name=URLPath]').val()+'GetStandardVar' ;
				var dict={'StandardName':StandardName,'StandardVersion':StandardVersion,'IGDName':IGDName,'VarName':VarNameIn,'StandardType':MDSource} ;
			}

			else if (MDSource == 'Study') {
				var url=$('[name=URLPath]').val()+'GetStudyVar' ;
				var dict={'Study':Study,'DSName':IGDName,'VarName':VarNameIn,'VLMOID':''}
			}

			$.getJSON(url,dict,function(data) {

				var VarName=data[0]['Name'];
				var VarLabel=data[0]['Label'];
				var VarSASType=data[0]['SASType'];
				var VarSASLength=data[0]['SASLength'];
				var VarOrderNumber=data[0]['OrderNumber'] ;
				var VarMandatory=data[0]['Mandatory'] ;
				var VarDataType=data[0]['DataType'] ;
				var VarOID=data[0]['OID'] ;

				if (MDSource == 'Study') {
					//$('[name=StudyCTName]').val(data[0]['CodeListNameStudy']) ;
					$('[name=CT1]').val(data[0]['CodeListNameStudy']) ;
					// Store in hidden dictionary that represents original study metadata
					$('[name=MD1]').val(JSON.stringify({'Name':VarName,'Label':VarLabel,'SASType':VarSASType,'DataType':VarDataType,'Origin':data[0]['Origin'],'SASLength':VarSASLength,'OrderNumber':VarOrderNumber,'Mandatory':VarMandatory,'OID':VarOID})) ;
				}

				if (VarSASLength) {
					$('[name=VarSASLength]').val(VarSASLength) ;
				}

				if (VarOrderNumber) {
					$('[name=VarOrderNumber]').val(VarOrderNumber) ;
				}

				if (VarMandatory){
					$('option[value='+VarMandatory+']').prop('selected',true);
				}

				if (VarDataType) {
					$('option[value='+VarDataType+']').prop('selected',true);
				}

				if (CustomYN == 'true') {
					$('#NameRow').append('<div class="col-xs-8 form-group"><input type="text" name="VarName" value="'+VarName+'"></div>') ;
					$('#LabelRow').append('<div class="col-xs-8 form-group"><input type="text" name="VarLabel" value="'+VarLabel+'"></div>') ;
					$('#SASTypeRow').append('<div class="col-xs-8 form-group"><select name="VarSASType"><option selected disabled></option><option value="Char">Char</option><option value="Num">Num</option></select></div>') ;

					if (VarSASType) {
						$('option[value='+VarSASType+']').prop('selected',true) ;
					}
				}

				else {
					$('#NameRow').append('<div class="col-xs-8 form-group">'+VarName+'</div>') ;
					$('#LabelRow').append('<div class="col-xs-8 form-group">'+VarLabel+'</div>') ;
					$('#SASTypeRow').append('<div class="col-xs-8 form-group">'+VarSASType+'</div>') ;
					MDDic['Label']=VarLabel ;
					MDDic['SASType']=VarSASType;
					$('[name=MD]').val(JSON.stringify(MDDic)) ;
				}

				// Add the standard CT code to the hidden variable
				$('[name=CTCode]').val(data[0]['CLCode']) ;
				$('[name=StandardCTName]').val(data[0]['CodeListName']) ;
				$('[name=CTDecodeYN]').val(data[0]['DecodeYN']) ;
				$('[name=CTExt').val(data[0]['Extensible']) ;
			}) ;
		}

		else {
			$('#NameRow').append('<div class="col-xs-8 form-group"><input type="text" name="VarName" value="'+MDDic['Name']+'"></div>') ;
			$('#LabelRow').append('<div class="col-xs-8 form-group"><input type="text" name="VarLabel"></div>') ;
			$('#SASTypeRow').append('<div class="col-xs-8 form-group"><select name="VarSASType"><option selected disabled></option><option value="Char">Char</option><option value="Num">Num</option></select></div>') ;
		}
	}

	function DisplayVarMD4VLM(Study,StandardName,StandardVersion,IGDName,VarNameIn,MDSource) {
		// MDSource can be Model, Standard, or Study, and determines where to go get the metadata from
		// If the user chose to define a new custom variable, then MDSource is null
		// If MDSource is Study, need to determine if the variable is custom or not (CustomYN)
		// CustomYN determines what is read-only 

		var VarName='',VarLabel='',VarSASType='',VarOrderNumber='',VarDataType='' ;
		var CustomYN=$('[name=CustomYN]').val() ;
		var MDDic=JSON.parse($('[name=MD]').val()) ;

		$('#mb').append('<p>Since this variable is being defined in subsets, we will define only a handful of properties at the variable level, and define the rest in the subsets we define.  Populate the fields below for the variable level.</p><div class="container"><div class="row" id="NameRow"><div class="col-xs-4">Name</div></div><div class="row" id="LabelRow"><div class="col-xs-4">Label</div></div><div class="row" id="SASTypeRow"><div class="col-xs-4">SAS Type</div></div><div class="row" id="OrderNumberRow"><div class="col-xs-4">Dataset Position</div><div class="col-xs-8 form-group"><input type="number" min="1" max="200" name="VarOrderNumber"></div></div><div class="row" id="DataTypeRow"><div class="col-xs-4">Data Type</div><div class="col-xs-8 form-group"><select name="VarDataType"><option selected disabled></option><option value= "text">text</option><option value="integer">integer</option><option value="float">float</option><option value="date">date</option><option value="datetime">datetime</option></select></div></div></div>') ;

		if (MDSource) {
			if (MDSource == 'Standard' || MDSource == 'Model') {
				var url=$('[name=URLPath]').val()+'GetStandardVar' ;
				var dict={'StandardName':StandardName,'StandardVersion':StandardVersion,'IGDName':IGDName,'VarName':VarNameIn,'StandardType':MDSource} ;
			}

			else if (MDSource == 'Study') {
				var url=$('[name=URLPath]').val()+'GetStudyVar' ;
				var dict={'Study':Study,'DSName':IGDName,'VarName':VarNameIn,'VLMOID':''}
			}

			$.getJSON(url,dict,function(data) {

				var VarName=data[0]['Name'];
				var VarLabel=data[0]['Label'];
				var VarSASType=data[0]['SASType'];
				var VarOrderNumber=data[0]['OrderNumber'] ;
				var VarDataType=data[0]['DataType'] ;
				var VarOID=data[0]['OID']

				if (MDSource == 'Study') {
					// Store in hidden dictionary that represents original study metadata
					$('[name=MD1]').val(JSON.stringify({'Name':VarName,'Label':VarLabel,'SASType':VarSASType,'DataType':VarDataType,'Origin':data[0]['Origin'],'OrderNumber':VarOrderNumber,'OID':VarOID})) ;
				}


				if (VarOrderNumber) {
					$('[name=VarOrderNumber]').val(VarOrderNumber) ;
				}

				if (VarDataType) {
					$('option[value='+VarDataType+']').prop('selected',true);
				}

				if (CustomYN == 'true') {
					$('#NameRow').append('<div class="col-xs-8 form-group"><input type="text" name="VarName" value="'+VarName+'"></div>') ;
					$('#LabelRow').append('<div class="col-xs-8 form-group"><input type="text" name="VarLabel" value="'+VarLabel+'"></div>') ;
					$('#SASTypeRow').append('<div class="col-xs-8 form-group"><select name="VarSASType"><option selected disabled></option><option value="Char">Char</option><option value="Num">Num</option></select></div>') ;

					if (VarSASType) {
						$('option[value='+VarSASType+']').prop('selected',true) ;
					}
				}

				else {
					$('#NameRow').append('<div class="col-xs-8 form-group">'+VarName+'</div>') ;
					$('#LabelRow').append('<div class="col-xs-8 form-group">'+VarLabel+'</div>') ;
					$('#SASTypeRow').append('<div class="col-xs-8 form-group">'+VarSASType+'</div>') ;
					MDDic['Label']=VarLabel ;
					MDDic['SASType']=VarSASType;
					$('[name=MD]').val(JSON.stringify(MDDic)) ;
				}
			}) ;
		}

		else {
			$('#NameRow').append('<div class="col-xs-8 form-group"><input type="text" name="VarName" value="'+MDDic['Name']+'"></div>') ;
			$('#LabelRow').append('<div class="col-xs-8 form-group"><input type="text" name="VarLabel"></div>') ;
			$('#SASTypeRow').append('<div class="col-xs-8 form-group"><select name="VarSASType"><option selected disabled></option><option value="Char">Char</option><option value="Num">Num</option></select></div>') ;
		}
	}
	function DisplayDtypeMethods(Study,DSName) {

		$.getJSON($('[name=URLPath]').val()+'GetDerivedRows',{'Study':Study,'DSName':DSName},function(data){
			if (data.length) {
				$('#mb').append('<p>Since you have defined derived records (DTYPE records) for some parameters, you need to indicate how this variable will be defined for such records.  For each row in the table below, indicate whether the value of this variable on the indicated derived record will be null, retained from parent records from which it was derived, or something else (you will have a chance to specify.<table id="parmdtypes" data-unique-id="OID"></table>')

				$('#parmdtypes').bootstrapTable({
					columns:[{
						field:'OID',
						class:'hidden'
					},{
						field:'Condition',
						title:'DTYPE Condition'
					},{
						field:'null',
						title:'Set to Null',
						align:'center'
					},{
						field:'retain',
						title:'Retain value from parent records',
						align:'center'
					},{
						field:'other',
						title:'Other (specify)',
						align:'center'
					},{
						field:'Description',
						title:'Specify'
					}]
				})

				$.each(data,function() {
					$('#parmdtypes').bootstrapTable('append',[{'OID':this['OID'],'Condition':'PARAMCD='+this['PARAMCD']+' and DTYPE='+this['DTYPE'],'null':'<input type="radio" style="text-align:center" name="OID'+this['OID']+'" value="null">','retain':'<input type="radio" style="text-align:center" name="OID'+this['OID']+'" value="retain">','other':'<input type="radio" style="text-align:center" name="OID'+this['OID']+'" value="other">','Description':''}]);
				})

				$('[id^=ToComment]').attr('id','ToBDSComment')
			}

			else {
				DisplayMethodComment(type='cvar') ;
				$('[id^=ToComment]').attr('id','ToFinalFromComment') ;
			}
		})
	}
</script>

</body>