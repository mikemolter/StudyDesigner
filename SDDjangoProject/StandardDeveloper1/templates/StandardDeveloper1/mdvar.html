<link rel="stylesheet" href="https://www.w3schools.com/w3css/3/w3.css">

<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	<script>
		$(document).ready(function(){
			// When adding the variable for the first time, ask if VLM will be necessary
			{% if Action == "Add" and not CondExist %}
				$('#R11').append("<p>Is metadata for this variable defined in subsets?</p><input type='radio' name='vlm' value='Y'/> Yes<br><input type='radio' name='vlm' value='N'/> No<br><br><input type='Button' id='vlmbutton' value='Submit' class='w3-button w3-dark-grey w3-round-large'>")
			// Otherwise if editing a current variable defined by VLM, then display the conditions
			{% elif CondExist and FromVar %}
				LoadVLMConditions() ;

			{% elif CondExist %}
				LoadMD('VLM') ;
			// Otherwise if editing variable level metadata 
			{% else %}
				LoadMD('Var') ;
			{% endif %}


			// When adding a variable, load VLM conditions if user said this variable is defined by VLM, otherwise, load variable-level fields
			$('form').on('click','#vlmbutton',function(){
				// Determine which choice was selected
				var VLM=$("input[name=vlm]:checked").val() ;

				if (VLM == 'Y'){
					LoadVLMConditions()
				}

				else {
					LoadMD('Var')
				}
			})

			// Get the list of all global codelists
			// $("[id*='GlobalCodeLists']").click(function(){
			$("form").on("click","[id*='GlobalCodeLists']",function(){
				var id=$(this).attr('id');
				var tagnbr=id.slice(id.length-1);
				$("#C"+tagnbr+'1').html('<table border="1" style="background-color:white" id="tblCL"><tr><th>Code</th><th>CodeList</th><th>Button</th></tr>');
				$.getJSON('http://localhost:8000/StandardDeveloper1/GetAllGlobalCL',function(data){
					$.each(data,function(){
						$("#tblCL").append('<tr><td>'+this['Code']+'</td><td>'+this['Name']+'</td><td><button type="button" id="'+tagnbr+this['Code']+'" value="'+this['Code']+'">Select</button></td></tr>');
					});
				});
			})

			// Get the items of one global codelist that is identified by its C-code
			$("form").on("click","button",function(){
				var tagnbr=$(this).attr('id').slice(0,1);
				var alias=$(this).val() ;
				$("#PCG").val(alias);
				$.getJSON('http://localhost:8000/StandardDeveloper1/Get1GlobalCodeList',{'CLCode':$(this).val()},function(data){
					$("#tblCL").remove();
					var CTName=data[0]['Name'];
					var DataType=data[0]['DataType'];
					var Extensible=data[0]['Extensible'];
					if (data[0]['Decode']){
						var DecodeYN='Y';
					}
					else {
						var DecodeYN='N';
					}
					BuildCTTable(DecodeYN,tagnbr,CTName,DataType,alias,Extensible);
					var cboxstring="CheckBox(this,'"+DecodeYN+"')";
					if (DecodeYN == 'Y'){
						$.each(data,function(){
							$("#t1").append('<tr><td>'+this['Term']+'</td><td>'+this['Decode']+'</td><td class="w3-center"><input type="checkbox" class="ec" name="stdterm_'+this['Term']+'"/></td></tr>');
						});
					}
					else {
						$.each(data,function(){
							$("#t1").append('<tr><td>'+this['Term']+'</td><td class="w3-center"><input type="checkbox" class="ec" name="stdterm_'+this['Term']+'"/></td></tr>');
						});
					}
				});
			});

			// If user decides to choose radio button to select condition from dropdown, then enable the dropdown
			$('form').on('click','#wc1',function(){
				$('#wc1list').prop('disabled',false);
				$('#parmoper').prop('disabled',true);
				$('#parmlist').prop('disabled',true);
			})

			$('form').on('click','#wc2',function(){
				$('#wc1list').prop('disabled',true);
				$('#parmoper').prop('disabled',false);
				$('#parmlist').prop('disabled',false);
			})

			// Once the condition is completed, create a string (var1|operator1|value1;varn|operatorn|valuen) that defines the where clause and put it into a hidden input, as well as a <p> element on the metadata page.
			$('form').on('click','#CompleteCondition',function(){
				if ($('#VarName2').val()){
					$('#VarName').val($('#VarName2').val());
				}

				if ($('#VarLabel2').val()){
					$('#VarLabel').val($('#VarLabel2').val());
				}

				if ($('#VarSASType2').val()){
					$('#VarSASType').val($('#VarSASType2').val());
				}

				if ($('#VarOrderNumber2').val()){
					$('#VarOrderNumber').val($('#VarOrderNumber2').val());
				}

				if ($('#VarDataType2').val()){
					alert ('VARDATATYPE2: '+$('#VarDataType2').val());
					$('#VarDataType').val($('#VarDataType2').val());
				}

				if ($('#wc1').prop('checked')) {
					$('#Cond').val($('#wc1list').val());
				}
				else {
					$('#Cond').val('PARAMCD|'+$('#parmoper').val()+'|'+$('#parmlist').val());
				}
				LoadMD('VLM');
			})


		});
	</script>

</head>

<body>

<div class="w3-container w3-center w3-large">
	<p><b>STUDY: {{Study}}<br/>
	DATASET: {{DSName}}</b></p>
	<p>Here we define the metadata for the chosen variable</p>
</div>

<div class="w3-container w3-teal" style="height:100%">
	<form method="post" action='NewVar' class="w3-container w3-teal" id="fid">
	{% csrf_token %}

	<div id='hidemisc'>
		<input type="hidden" name="DSName" value="{{DSName}}"/>
		<input type="hidden" name="RSType" value="{{RSType}}"/>
		<input type="hidden" name="SourceName" value="{{SourceName}}"/>
		<input type="hidden" name="SourceDescription" value="{{SourceDescription}}"/>
		<input type="hidden" name="SourceOrder" value="{{SourceOrder}}"/>
		<input type="hidden" name="SourceJoin" value="{{SourceJoin}}"/>
		<input type="hidden" name="Study"  value="{{Study}}"/>
		<input type="hidden" name="StandardName" value="{{StandardName}}"/>
		<input type="hidden" name="StandardVersion" value="{{StandardVersion}}"/>
		<input type="hidden" name="ReturnTo" value="{{ReturnTo}}"/>
		<input type="hidden" name="VarSource" value="{{VarSource}}"/>
		<input type="hidden" name="Class" value="{{Class}}"/>
		<input type="hidden" name="CTStdYN" value="{{CTStdYN}}"/>
		<input type="hidden" name="Action" value="{{Action}}"/>
		<input type="hidden" name="ParentCodelistGlobal" id="PCG" value="{{ParentCodelistGlobal}}"/>
		<input type="hidden" name="ParentCodelistStudy" id="PCS"/>
		<input type="hidden" name="Condition" id="Cond"/>
		<input type="hidden" name="WCOID" id="WCOID"/>
		<input type="hidden" name="PredStdYN" value="{{PredStdYN}}"/>
		<input type="hidden" name="BeforeVarName" value="{{VarMD.Name}}"/>
		<input type="hidden" name="VarName" id='VarName' value="{{VarMD.Name}}"/>
		<input type="hidden" name="VarLabel" id='VarLabel' value="{{VarMD.Label}}"/>
		<input type="hidden" name="VarSASType" id='VarSASType' value="{{VarMD.SASType}}"/>
		<input type="hidden" name="VarOrderNumber" id='VarOrderNumber' value="{{VarMD.OrderNumber}}"/>
		<input type="hidden" name="VarDataType" id='VarDataType' value="{{VarMD.DataType}}"/>
		<input type="hidden" name="VarMandatory" id='VarMandatory' value="{{VarMD.Mandatory}}"/>
	</div>

	<div class="w3-cell-row" id="R1">
		<div class="w3-cell" id="R11" style="width:50%"></div>
		<div class="w3-cell" id="R12" style="width:50%"></div>
	</div>


	<div id="M1" class="w3-container w3-left w3-large"></div>

	<div id="hidesrc"></div>

	<p id='I1'></p>

	<div id='C1' class='w3-cell-row'>
		<div id='C11' class='w3-cell' style='width:75%'></div>
		<div id='C12' class='w3-cell' style='width:25%'></div>
	</div>

	<p id='I2'></p>

	<div id='C2' class='w3-cell-row'>
		<div id='C21' class='w3-cell' style='width:75%'></div>
		<div id='C22' class='w3-cell' style='width:25%'></div>
	</div>

	<p id="I3"></p>

	<div id='C3' class='w3-cell-row'>
		<div id='C31' class='w3-cell' style='width:75%'></div>
		<div id='C32' class='w3-cell' style='width:25%'></div>
	</div>

	<div id='hideCT'>
	</div>

	<br/><br/>

	<div id='submitbuttons' class="w3-bar w3-center"></div>

	<p id='test'></p>

	</form>
</div>
</body>

<script type="text/javascript">

	function LoadVLMConditions(){
		$('#R11').empty();
		// First collect/display basic variable-level metadata
		$('#R11').append('<h1>Variable-level information</h1><br>') ;

		{% if Action == "Add" and RSType == "OTHER" or Action == "Add" and PredStdYN == "N" %}
			$('#R11').append('<label>Variable Name</label><br><input type="text" maxlength="8" size="8" id="VarName2" value="{{VarMD.Name}}"/><br><br/>');
		{% else %}
			$('#R11').append('<p>Variable Name: {{VarMD.Name}}</p>');
		{% endif %}


		{% if RSType == "OTHER" or PredStdYN == "N" and Action == "Add" %}
			$('#R11').append('<label>Variable Label</label><br><input type="text" maxlength="40" size="40" id="VarLabel2" value="{{VarMD.Label}}"/><br/><br/><label>SAS Type</label><br><select id="VarSASType2"><option selected disabled/><option value="Char">Char</option><option value="Num">Num</option></select><br><br/>');
			var SASType = "{{VarMD.SASType}}";
			if (SASType){
				$('option[value='+SASType+']').prop('selected',true);
			}

		{% else %}
			$('#R11').append('<p>Variable Label: {{VarMD.Label}}</p><p>Variable SAS Type: {{VarMD.SASType}}</p>');
		{% endif %}

		$('#R11').append('<label>Order in data set</label><br><input type="number" id="VarOrderNumber2" min="1" max="500" value="{{VarMD.OrderNumber}}"/><br><br/><label>Data Type</label><br><select id="VarDataType2"><option selected disabled></option><option value= "text">text</option><option value="integer">integer</option><option value="float">float</option><option value="date">date</option><option value="datetime">datetime</option></select><br><br><hr>');

		var DataType = "{{VarMD.DataType}}";
		if (DataType) {
			$('option[value='+DataType+']').prop('selected',true);
		}


		// Now define a condition
		$('#R11').append('<h1>Subset Definition</h1><p>BDS metadata is defined by parameters.  Define a parameter-based condition by selecting from the dropdown, or in the event that an operator other than "equal" is needed or that multiple parameters define a condition, select "Custom".  If additional conditions based on other variables are needed, click "Add Condition".</p><input type="radio" name="parmconditionapproach" id="wc1"> Choose from list</input><br><br><select id="wc1list"><option disabled selected>Select a condition</option> ');

		$('#wc1list').prop('disabled',true);


		{% if Action == 'Edit' %}

			$('#R12').append('<p>Conditions already defined for {{VarMD.Name}}</p><table border="1" style="background-color:white" id="tblR12"><tr><th>Condition</th><th>Edit Metadata</th><th>Remove Metadata</th></tr>')

			$.getJSON('http://localhost:8000/StandardDeveloper1/GetPotentialWhereConditions',{'Study':"{{Study}}",'DSName':"{{DSName}}",'VarName':"{{VarMD.Name}}"},function(data){
				$.each(data,function(data){
					$('#tblR12').append('<tr><td>'+this['Condition'])+'</td><td><input type="submit" class="w3-button w3-dark-grey w3-round-large" formaction="QSVMD" name="vlmedit_'+str(this['WCOID'])+'" value="Edit"/></td><td><input type="submit" class="w3-button w3-dark-grey w3-round-large" name="vlmrmv_'+str(this['WCOID'])+'" value="Remove"/></td></tr>'
				})
			})

		{% else %}

			$('#R12').append('<p>Conditions already defined for {{VarMD.Name}}</p><table border="1" style="background-color:white" id="tblR12"><tr><th>Condition</th></tr>')

			$.getJSON('http://localhost:8000/StandardDeveloper1/GetPotentialWhereConditions',{'Study':"{{Study}}",'DSName':"{{DSName}}",'VarName':"{{VarMD.Name}}"},function(data){
				$.each(data,function(data){
					$('#tblR12').append('<tr><td>'+this['Condition'])+'</td></tr>'
				})
			})
		{% endif %}

		// Get all potential PARAMCD/DTYPE conditions that have not yet been defined for this variable
		$.getJSON('http://localhost:8000/StandardDeveloper1/GetPotentialWhereConditions',{'Study':"{{Study}}",'DSName':"{{DSName}}",'VarName':"{{VarMD.Name}}"},function(data){
			$.each(JSON.parse(data),function(){
				if (this['_merge'] == 'left_only') {
					if (this['merge1'] == 'both') {
						$('#wc1list').append('<option value="PARAMCD|EQ|'+this['PARAMCD']+';DTYPE|EQ|'+this['DTYPE']+'">PARAMCD="'+this['PARAMCD']+'" and DTYPE="'+this['DTYPE']+'"</option>');
					}
					else {
						$('#wc1list').append('<option value="PARAMCD|EQ|'+this['PARAMCD']+'">PARAMCD="'+this['PARAMCD']+'"</option>');
					}
				}
			})
		})

		// Define custom parameter-based condition
		$('#R11').append('<p><input type="radio" name="parmconditionapproach" id="wc2"> Custom</input></p><p>PARAMCD&nbsp;<select id="parmoper"><option disabled selected>Select an operator</option><option>EQ</option><option>IN</option><option>NE</option><option>GT</option><option>LT</option><option>NOT IN</option></select>&nbsp;<select multiple id="parmlist"><option disabled selected>Select one or more parameters</option>') ;

		// Get parameter list 
		$.getJSON('http://localhost:8000/StandardDeveloper1/GetParmList',{'Study':"{{Study}}",'DSName':"{{DSName}}"},function(data){
			$.each(JSON.parse(data),function(){
				$('#parmlist').append('<option>'+this['PARAMCD']+'</option>')
			})
		})

		$('#parmoper').prop('disabled',true);
		$('#parmlist').prop('disabled',true);

		$('#R11').append('<p><input type="button" id="CompleteCondition" value="Ok" class="w3-button w3-dark-grey w3-round-large"/></p>')
	}

	function LoadMD(Level){
		var VarName=$('#VarName').val() ;
		$('#R11').empty();

		if (Level == 'Var') {

			{% if Action == "Add" and RSType == "OTHER" or Action == "Add" and PredStdYN == "N" %}
				$('#R11').append('<label>Variable Name</label><br><input type="text" maxlength="8" size="8" name="VarName"/><br><br/>');
			{% else %}
				$('#R11').append('<p>Variable Name: {{VarMD.Name}}</p><input type="hidden" name="VarName" value="{{VarMD.Name}}"/>');
			{% endif %}


			{% if RSType == "OTHER" or PredStdYN == "N" and Action == "Add" %}
				$('#R11').append('<label>Variable Label</label><br><input type="text" maxlength="40" size="40" name="VarLabel" value="{{VarMD.Label}}"/><input type="hidden" name="BeforeVarLabel" value="{{VarMD.Label}}"/><br><label>SAS Type</label><br><select name="VarSASType"><option value="Char">Char</option><option value="Num">Num</option></select><br><br/><input type="hidden" name="BeforeVarSASType" value="{{VarMD.VarSASType}}"/>');
				var SASType = "{{VarMD.SASType}}";
				if (SASType){
					$('option[value='+SASType+']').prop('selected',true);
				}

			{% else %}
				$('#R11').append('<p>Variable Label: {{VarMD.Label}}</p><p>Variable SAS Type: {{VarMD.SASType}}</p><input type="hidden" name="VarLabel" value="{{VarMD.Label}}"/><input type="hidden" name="VarSASType" value="{{VarMD.SASType}}"/>');
			{% endif %}


			var R12String = '<label>Length</label><br><input type="number" name="VarSASLength" min="1" max="200" value="{{VarMD.SASLength}}"/><br><br/><input type="hidden" name="BeforeVarSASLength" value="{{VarMD.SASLength}}"/><label>Order in data set</label><br><input type="number" name="VarOrderNumber" min="1" max="500" value="{{VarMD.OrderNumber}}"/><br><br/><input type="hidden" name="BeforeVarOrderNumber" value="{{VarMD.OrderNumber}}"/><label>Mandatory</label><br><select name="VarMandatory"><option selected disabled></option><option value="No">No</option><option value="Yes">Yes</option></select><br><br/><input type="hidden" name="BeforeVarMandatory" value="{{VarMD.Mandatory}}"/><label>Data Type</label><br><select name="VarDataType"><option selected disabled></option><option value= "text">text</option><option value="integer">integer</option><option value="float">float</option><option value="date">date</option><option value="datetime">datetime</option></select><br/><br/><input type="hidden" name="BeforeVarDataType" value="{{VarMD.DataType}}"/>';

			$('#R12').append(R12String) ;
			var Mandatory = "{{VarMD.Mandatory}}";
			var DataType = "{{VarMD.DataType}}";

			if (Mandatory){
				$('option[value='+Mandatory+']').prop('selected',true);
			}

			if (DataType) {
				$('option[value='+DataType+']').prop('selected',true);
			}

			var OriginString='<label>Origin</label><br><select name="VarOrigin"><option value="Assigned">Assigned</option><option value="Derived">Derived</option><option value="Predecessor">Predecessor</option></select><br><input type="hidden" name="BeforeVarOrigin" value="{{VarMD.Origin}}"/>' ;
			var Origin = "{{VarMD.Origin}}";

			{% if RSType == "MAIN" or RSType == "MERGE" %}
				$('#R11').append('<p>Variable Origin: Predecessor ({{SourceName}})</p><input type="hidden" name="VarOrigin" value="Predecessor"/><input type="hidden" name="src_{{SourceOrder}}"/>') ;

			{% else %}
				$('#R12').append(OriginString) ;
				if (Origin) {
					$('option[value='+Origin+']').prop('selected',true);
				}
			{% endif %}
		}

		else {

			var OriginString='<label>Origin</label><br><select name="VLMOrigin"><option disabled selected/><option value="Assigned">Assigned</option><option value="Derived">Derived</option><option value="Predecessor">Predecessor</option></select><br><input type="hidden" name="BeforeVLMOrigin" value="{{VLMD.Origin}}"/>';

			var condtext='' ;
			var cond1 = $('#Cond').val() ;
			var cond2 = cond1.split(';') ;
			for (x in cond2) {
				if (x != 0) {
					condtext += ' and ' ;
				}
				var cond3 = cond2[x].split('|') ;
				for (y in cond3) {
					condtext += cond3[y]+' ' ;
				}
			}

			$('#R11').append('<p>Variable Name:  '+VarName+'</p><p>Subset Definition:  Where '+condtext+'</p><label>Subset Name</label><br><input type="text" maxlength="8" size="8" name="VLMName" value="{{VLMD.Name}}"/><br><br/><label>Subset Label</label><br><input type="text" maxlength="40" size="40" name="VLMLabel" value="{{VLMD.Label}}"/><br/><br/><input type="hidden" name="BeforeVLMLabel" value="{{VLMD.Label}}"/><br>'+OriginString);

			$('#R12').append('<label>Length</label><br><input type="number" name="VLMLength" min="1" max="200" value="{{VLMD.Length}}"/><br><br/><input type="hidden" name="BeforeVLMLength" value="{{VLMD.Length}}"/><label>Mandatory</label><br><select name="VLMMandatory"><option selected disabled></option><option value="No">No</option><option value="Yes">Yes</option></select><br><br/><input type="hidden" name="BeforeVLMMandatory" value="{{VLMD.Mandatory}}"/><label>Data Type</label><br><select name="VLMDataType"><option selected disabled></option><option value= "text">text</option><option value="integer">integer</option><option value="float">float</option><option value="date">date</option><option value="datetime">datetime</option></select><br/><br/><input type="hidden" name="BeforeVLMDataType" value="{{VLMD.DataType}}"/>');

			var Mandatory = "{{VLMD.Mandatory}}";
			var DataType = "{{VLMD.DataType}}";

			if (Mandatory){
				$('option[value='+Mandatory+']').prop('selected',true);
			}

			if (DataType) {
				$('option[value='+DataType+']').prop('selected',true);
			}

			var Origin = "{{VLMD.Origin}}";
			if (Origin) {
				$('option[value='+Origin+']').prop('selected',true);
			}
		}

		{% if RSType != 'MAIN' and RSType != 'MERGE' %}

			var functioncall = "methodchoice('Y')" ;
			$('#M1').append('<p> Select an approach to defining programming instructions</p><input type="radio" class="methodchoice w3-radio" name="methods" value="m1" id="m1">Define a programming instruction for each allowable value</input><br/><input type="radio" class="methodchoice w3-radio" name="methods" value="m2" onclick="'+functioncall+'">Define programming instructions separate from allowable values</input><br/>') ;

			var functioncall = "methodchoice('N')" ;
			{% if not CTTable %}
				$('#M1').append('<input type="radio" class="methodchoice w3-radio" name="methods" value="m3" onclick="'+functioncall+'">Define programming instruction and no allowable values</input>') ;

			{% else %}
				var WhichMethodApproach = "{{MethodType}}" ;
				if (WhichMethodApproach) {
					if (WhichMethodApproach == '3') {
						WhichMethodApproach = '2' ;
					}
					$('input[value=m'+WhichMethodApproach+']').prop('checked',true) ;
				}
			{% endif %}

			{% if Action == "Edit" %}
				methodchoice('Y') ;
			{% endif %}

		{% else %}
			BuildCT('1') ;

		{% endif %}



		$('#M1').append('<p/>') ;

		var SBString = "<input type='submit' class='w3-button w3-dark-grey w3-round-large' value='Save Variable' ";
		
		{% if Action == 'Edit' %}
			SBString += 'formaction="ESV" ' ;
		{% endif %}

		SBString += "/>&nbsp;" ;
		if (Level == 'VLM') {
			SBString += "<input type='submit' class='w3-button w3-dark-grey w3-round-large' name='SaveSubset' value='Save Subset'/>&nbsp;" ;
		}

		SBString += "<input type='submit' class='w3-button w3-dark-grey w3-round-large' value='Cancel'/>" ;
		$('#submitbuttons').append(SBString) ;

	}

	function methodchoice(m23){
		$(document).ready(function(){
			// Get currently existing sources
			$('#C11').html('<table border="1" style="background-color:white" id="tblSRC"><tr id="tr"><th>Dataset</th><th>Description</th><th>Join</th><th>Keep Source</th></tr>');
			$.getJSON('http://localhost:8000/StandardDeveloper1/GetStudySources',{'Study':"{{Study}}",'DSName':"{{DSName}}",'VarName':"{{VarMD.Name}}"},function(data){
				$.each(data,function(){
					if (this['VarIn'] == true){
						var chkstring='checked';
					}
					else {
						var chkstring='';
					}
					$("#tblSRC").append('<tr><td>'+this['Name']+'</td><td>'+this['Description']+'</td><td>'+this['Join']+'</td><td class="w3-center" id="src_'+this['Order']+'"><input name="src_'+this['Order']+'" type="checkbox" '+chkstring+'/></td></tr>');
				});
			});
			// Insert area to define new source
			NewSource();
			$('<input type="button" class="w3-button w3-dark-grey w3-round-large" value="OK" onclick="AddSource()"/><br/>').appendTo('#C12');

			// Depending on the radio button that was clicked, insert area to define method
			Method23(m23);
		})
	}

	function NewSource(){
		// Collect Source data set information
		var C12=document.getElementById('C12');
		var sourceinstruction=document.createElement('p');
		sourceinstruction.innerHTML='If necessary, define a new source data set for this variable';
		C12.appendChild(sourceinstruction);
		var modeldrop=document.createElement('select');
		modeldrop.name='NewSourceModel';
		var op0=document.createElement('option');
		op0.disabled=true;
		op0.selected=true;
		op0.text='Select SDTM or ADaM';
		var op1=document.createElement('option');
		op1.text='SDTM';
		var op2=document.createElement('option');
		op2.text='ADaM';
		modeldrop.appendChild(op0);
		modeldrop.appendChild(op1);
		modeldrop.appendChild(op2);
		C12.appendChild(modeldrop);
		C12.appendChild(document.createElement('br'));
		C12.appendChild(document.createElement('br'));
		var dsnamebox=document.createElement('input');
		dsnamebox.name='NewSourceName';
		dsnamebox.size='20';
		dsnamebox.placeholder='Source Dataset Name';
		C12.appendChild(dsnamebox);
		C12.appendChild(document.createElement('br'));
		C12.appendChild(document.createElement('br'));
		var descbox=document.createElement('textarea');
		descbox.cols='60';
		descbox.placeholder='Provide a description of the subset of the source data set (if any) (e.g excluding screen failures)';
		descbox.rows='3';
		descbox.name='NewSourceDescription';
		C12.appendChild(descbox);
		C12.appendChild(document.createElement('br'));
		C12.appendChild(document.createElement('br'));
		var joinbox=document.createElement('textarea');
		joinbox.placeholder="Provide a description of how the data sets are to be merged.";
		joinbox.rows='3';
		joinbox.cols='60';
		joinbox.name='NewSourceJoin';
		C12.appendChild(joinbox);
		C12.appendChild(document.createElement('br'));
		C12.appendChild(document.createElement('br'));
	}

	function Method23(ctyn){
		// Create the first radio button and its text
		var C21=document.getElementById('C21');
		var C22=document.getElementById('C22');

		// In case anything is already in these containers, remove it
		while(C21.firstChild) {
			C21.removeChild(C21.firstChild);
		}
		while(C22.firstChild) {
			C22.removeChild(C22.firstChild)
		}

		var r1=document.createElement('input');
		r1.setAttribute('type','radio');
		r1.setAttribute('onchange','disable1(this)');
		r1.name='methodchoice';
		r1.value='conditions';
		var r1L=document.createElement('label');
		var r1T=document.createTextNode(' Define a programming instruction with conditions, or ...');
		r1L.appendChild(r1T);
		C21.appendChild(r1);
		C21.appendChild(r1L);
		C21.appendChild(document.createElement('br'));
		C21.appendChild(document.createElement('br'));
		// Create the Else text box
		var elsebox = document.createElement('textarea');
		elsebox.cols="40";
		elsebox.rows="2";
		elsebox.name="else";
		elsebox.id="else";
		elsebox.className='w3-right';
		elsebox.placeholder='Else Result';
		C21.appendChild(elsebox);

		{% if MethodType == 2 %}
			{% for x in MethodMD %}
				{% if x.ElseFL2 == 'Y' %}
					elsebox.value="{{x.Then2}}";
				{% else %}
					Conditions("{{x.If2}}","{{x.Then2}}");
				{% endif %}
			{% endfor %}
			r1.checked=true;
		{% else %}
			// Create the first condition/result boxes
			Conditions();
			document.getElementsByClassName('cond')[0].disabled=true;
			document.getElementsByClassName('res')[0].disabled=true;
		{% endif %}


		// Create the button for adding conditions
		var addbutton=document.createElement('input');
		addbutton.type='button';
		addbutton.value='Add a Condition';
		{% if MethodType != 2 %}
			addbutton.disabled=true;
		{% endif %}
		addbutton.id='addbutton';
		addbutton.setAttribute('onclick','Conditions()');
		addbutton.className='w3-button w3-dark-grey w3-round-large w3-right';
		C22.appendChild(addbutton);
		// Create the second radio button
		C21.appendChild(document.createElement('br'));
		C21.appendChild(document.createElement('br'));
		C21.appendChild(document.createElement('br'));
		var r2=document.createElement('input');
		r2.setAttribute('type','radio');
		r2.setAttribute('onchange','disable2(this)');
		r2.name='methodchoice';
		r2.value='freetext';
		var r2L=document.createElement('label');
		var r2T=document.createTextNode(' ...define a programming instruction without conditions');
		r2L.appendChild(r2T);
		C21.appendChild(r2);
		C21.appendChild(r2L);
		C21.appendChild(document.createElement('br'));
		C21.appendChild(document.createElement('br'));
		// Create the freetext box
		var freebox = document.createElement('textarea');
		freebox.cols='80';
		freebox.rows='20';
		freebox.id='free';
		freebox.name='free';
		{% if MethodMD.Description3 %}
			freebox.value="{{MethodMD.Description3}}";
			r2.checked=true;
			freebox.disabled=false;
		{% else %}
			freebox.placeholder='Enter free text method here';
			freebox.disabled=true;
		{% endif %}
		
		C21.appendChild(freebox);

		// Now add the CT section
		if (ctyn == 'Y') {
			BuildCT('3')
		}
	}

	function Conditions(condvalue,resvalue){
		var C21=document.getElementById('C21');
		var elsebox=document.getElementById('else');
		var condcount=document.getElementsByClassName('Cond').length;
		condcount++;


		var cond = document.createElement('textarea');
		cond.name = 'cond'+condcount;
		cond.cols="40";
		cond.rows="2";
		cond.className="cond";
		if (condvalue){
			cond.value=condvalue ;
		}
		else {
			cond.placeholder='Condition '+condcount;
		}
		

		var res = document.createElement('textarea');
		res.name = 'res'+condcount;
		res.cols="40";
		res.rows="2";
		res.className="w3-right res"
		if (resvalue){
			res.value=resvalue;
		}
		else {
			res.placeholder='Result of Condition '+condcount ;
		}
		

		C21.insertBefore(cond,elsebox);
		C21.insertBefore(res,elsebox);

		C21.insertBefore(document.createElement('br'),elsebox);
		C21.insertBefore(document.createElement('br'),elsebox);
		
	}

	function disable1(obj) {
		if (obj.checked == true) {
			document.getElementById('else').disabled=false;
			document.getElementById('addbutton').disabled=false;
			document.getElementsByClassName('cond')[0].disabled=false;
			document.getElementsByClassName('res')[0].disabled=false;
		}
		else {
			document.getElementById('else').disabled=true;
			document.getElementById('addbutton').disabled=true;
			document.getElementsByClassName('cond')[0].disabled=true;
			document.getElementsByClassName('res')[0].disabled=true;
		}
	}

	function disable2(obj) {
		if (obj.checked == true) {
			document.getElementById('free').disabled=false;
		}
		else {
			document.getElementById('free').disabled=true;
		}
	}

	function BuildCT(tagnbr) {
		document.getElementById('I'+tagnbr).innerHTML = "{{InstructionCT}}";  // Insert CT instruction
		var C = document.getElementById('C'+tagnbr); // Get the row container 

		// If defining new CT, add a row of buttons to help get started

			var buttonrow = document.createElement("div"); // Create the button row 
			buttonrow.setAttribute("class","w3-bar w3-center");
			buttonrow.id = 'br1';

			var button1 = document.createElement("input");  // Create the first button
			button1.setAttribute("type","button");
			button1.setAttribute("class","w3-button w3-dark-grey w3-small w3-round-large");
			

			{% if CTStdYN == "Y" %}
				button1.setAttribute('value','Select an existing child codelist'); 
				buttonrow.appendChild(button1);

			{% else %} // Create two more buttons for custom codelists 
				button1.setAttribute('value','Start from an existing global codelist'); 
				button1.id="GlobalCodeLists"+tagnbr;
				buttonrow.appendChild(button1);

				var button2 = document.createElement("input");  // Create the second button
				button2.setAttribute("type","button");
				button2.setAttribute("class","w3-button w3-dark-grey w3-small w3-round-large");
				button2.setAttribute("value","Start from an existing study codelist");
				buttonrow.appendChild(button2);

				{% if not CTTable %}
					var DataType=document.getElementsByName('VarDataType')[0].value ;
					var button3 = document.createElement("input");  // Create the third button
					button3.setAttribute("type","button");
					button3.setAttribute("class","w3-button w3-dark-grey w3-small w3-round-large");
					button3.setAttribute("value","Define sponsor-defined coded values");
					button3.setAttribute("onclick","BuildCTTable('Y','"+tagnbr+"','','"+DataType+"','','Yes');");
					buttonrow.appendChild(button3);

					var button4 = document.createElement("input");  // Create the fourth button
					button4.setAttribute("type","button");
					button4.setAttribute("class","w3-button w3-dark-grey w3-small w3-round-large");
					button4.setAttribute("value","Define sponsor-defined uncoded values");
					button4.setAttribute("onclick","BuildCTTable('N','"+tagnbr+"','','"+DataType+"','','Yes');");
					buttonrow.appendChild(button4);
				{% endif %}
			{% endif %}

			document.getElementById('fid').insertBefore(buttonrow,C); // Insert the button row into the beginning of the container
			document.getElementById('fid').insertBefore(document.createElement('br'),C);

		{% if CTTable %} // if CT is already associated with the variable, display it in a table
			BuildCTTable("{{DecodeYN}}",tagnbr,"{{CTTable.Name}}","{{CTTable.DataType}}","{{CTTable.AliasCL}}","{{CTExt}}");
		{% endif %}

	}

	function BuildCTTable(CodedYN,tagnbr,CodeListName,DataType,Alias,Extensible){
		// Get rid of the button row
		// document.getElementById('fid').removeChild(document.getElementById('br1'));

		// Create the input box and label
		var CTName = document.createElement('input');
		CTName.maxLength = '40';
		CTName.size = '40';
		CTName.name = 'CTName';
		CTName.value = CodeListName ;

		var label = document.createElement('label');
		var labeltext = document.createTextNode('Codelist Name');
		label.appendChild(labeltext);
		var Cx1 = document.getElementById('C'+tagnbr+'1'); // Get the left-most cell in the row container
		Cx1.appendChild(label);
		Cx1.appendChild(document.createElement('br'));
		Cx1.appendChild(CTName);
		Cx1.appendChild(document.createElement('br'));
		Cx1.appendChild(document.createElement('br'));

		// Create hidden elements for datatype, extensible, and alias
		var hidect = document.getElementById('hideCT') ;
		var datatype = document.createElement('input') ;
		datatype.setAttribute('type','hidden');
		datatype.name = 'CTDataType';
		datatype.value = DataType ;
		hidect.appendChild(datatype);

		var alias = document.createElement('input');
		alias.setAttribute('type','hidden');
		alias.name = 'CTAlias' ;
		alias.value = Alias ;
		hidect.appendChild(alias);

		var ext = document.createElement('input');
		ext.setAttribute('type','hidden');
		ext.name = 'CTExtensible' ;
		ext.value = Extensible ;
		hidect.appendChild(ext);

		// Create the Clear All and Select All buttons
		var Dx1 = document.createElement("div"); // Create a container for the button row 
		Cx1.appendChild(Dx1);


		var buttonrow2 = document.createElement("div"); // Create the button row 
		buttonrow2.setAttribute("class","w3-bar w3-left");

		var buttonClear = document.createElement("input");  // Create the Clear All button
		buttonClear.setAttribute("type","button");
		buttonClear.setAttribute("class","w3-button w3-dark-grey w3-round-large");
		buttonClear.setAttribute("value","Clear All");
		buttonClear.setAttribute("onclick","AllChecks('clear');")
		buttonrow2.appendChild(buttonClear);

		var buttonSelect = document.createElement("input");  // Create the Select All button
		buttonSelect.setAttribute("type","button");
		buttonSelect.setAttribute("class","w3-button w3-dark-grey w3-round-large");
		buttonSelect.setAttribute("value","Select All");
		buttonSelect.setAttribute("onclick","AllChecks('select');")
		buttonrow2.appendChild(buttonSelect);

		Dx1.appendChild(buttonrow2); // Put the button row in the container



		// Create the table
		var Dx2 = document.createElement('div'); // Create a container for the table
		Cx1.appendChild(Dx2);
		var table = document.createElement('table');
		table.id = 't1' ;
		table.setAttribute('border','1');
		table.setAttribute('style','background-color:white; width:80%; table-layout:fixed');


		// insert data 
		{% for x in CTTable %}
			var newrow = table.insertRow(-1);
			var term = newrow.insertCell(0) ;
			term.innerHTML = "{{ x.CodedValue }}" ;
			if (CodedYN == 'Y') {
				var decode = newrow.insertCell(1);
				decode.innerHTML = "{{ x.Decode }}" ;
			}
			var keepcell = newrow.insertCell(-1) ;
			keepcell.setAttribute('class','w3-center');
			var keepcb = document.createElement('input');
			keepcb.setAttribute('type','checkbox');
			keepcb.setAttribute('class','ec');

			{% if x.AliasItem %}
				keepcb.name='stdterm_{{x.CodedValue}}';
			{% else %}
				keepcb.name='extterm_{{x.CodedValue}}';
			{% endif %}

			{% if StudyList %}
				{% if x.CodedValue in StudyList %}
					keepcb.checked=true;
				{% else %}
					keepcb.checked=false;
				{% endif %}
			{% endif %}

			keepcell.appendChild(keepcb) ;
		{% endfor %}

		// insert table headers 
		var head = table.createTHead() ;
		var row = head.insertRow(0);
		var cell0 = row.insertCell(0);
		cell0.innerHTML = '<b>Term</b>' ;
		var cell1 = row.insertCell(1);
		if (CodedYN == 'Y') {
			cell0.setAttribute('style','width:30%');
			cell1.innerHTML = '<b>Decode</b>';
			cell1.setAttribute('style','width:60%');
			var cell2 = row.insertCell(2) ;
			cell2.innerHTML = '<b>Keep Term</b>';
		}
		else {
			cell0.setAttribute('style','width:90%');
			cell1.innerHTML = '<b>Keep Term</b>';
		}
		Dx2.appendChild(table);



		// Create the input area for new terms
		if (Extensible == "Yes") {
			var Cx2 = document.getElementById("C"+tagnbr+'2');
			var term = document.createElement("textarea");
			var addbutton = document.createElement("input");
			var text = document.createElement('p') ;
			text.innerHTML = 'Define extended terms below' ;

			addbutton.setAttribute("type","button");
			addbutton.setAttribute("class","w3-button w3-dark-grey w3-round-large");
			addbutton.setAttribute("value","OK");
			addbutton.setAttribute("onclick","AddTerm('"+CodedYN+"');");
			term.setAttribute("cols","40");
			term.setAttribute("rows","2");
			term.id="ta1";
			Cx2.appendChild(text) ;
			Cx2.appendChild(term);

			if (CodedYN == "Y") {
				term.setAttribute("placeholder","Enter coded value here") ;
				var decode = document.createElement("textarea") ;
				decode.setAttribute("cols","40");
				decode.setAttribute("rows","5");
				decode.id="ta2";
				decode.setAttribute('placeholder','Enter decode here') ;
				Cx2.appendChild(document.createElement('br'));
				Cx2.appendChild(document.createElement('br'));
				Cx2.appendChild(decode); 
			}
			else {
				term.setAttribute('placeholder','Enter uncoded value here') ;
			}
			Cx2.appendChild(document.createElement('br'));
			Cx2.appendChild(document.createElement('br'));
			Cx2.appendChild(addbutton);
		}
	}

function AllChecks(CheckType) {
    var x = document.getElementsByClassName("ec");
    var i;
    if (CheckType == "select"){
    for (i = 0; i < x.length; i++) {
            x[i].checked = true;
        }
    }

	else {
	    for (i = 0; i < x.length; i++) {
            x[i].checked = false;
    	}
	}
}

	function AddTerm(CodedYN) {
		// Add row to table
		var table = document.getElementById("t1") ;
		var ta1 = document.getElementById("ta1");
		var newrow = table.insertRow(-1);
		var term = newrow.insertCell(0) ;
		term.innerHTML=ta1.value ;
		if (CodedYN == 'Y') {
			var ta2 = document.getElementById("ta2");
			var decode = newrow.insertCell(1) ;
			decode.innerHTML=ta2.value ;
			ta2.value = ''; 
			ta2.setAttribute('placeholder','Enter decode here') ;
		}
		var keepcell = newrow.insertCell(-1) ;
		keepcell.setAttribute('class','w3-center');

		var keepcb = document.createElement('input');
		keepcb.setAttribute('type','checkbox');
		keepcb.setAttribute('class','ec');
		keepcb.checked = true ;
		keepcb.setAttribute('onchange','CheckBox(this,"'+CodedYN+'")');
		keepcell.appendChild(keepcb) ;
		CheckBox(keepcb,CodedYN);
		ta1.value = '' ;
		ta1.setAttribute('placeholder','Enter coded value here') ;

	}

	function AddSource() {
		var table = document.getElementById("tblSRC") ;

		// Determine what the Order value should be for this source
		var rows=table.rows ;
		var maxOrder=0;
		for (x=0; x<rows.length; x++) {
			var thisid=rows[x].cells[3].id;
			var thisorder=Number(thisid.substr(4));
			var maxOrder=Math.max(maxOrder,thisorder);
		}
		var Order=maxOrder+1;

		// Add row to table
		var Model = document.getElementsByName("NewSourceModel")[0];
		var Name = document.getElementsByName("NewSourceName")[0];
		var Desc = document.getElementsByName("NewSourceDescription")[0];
		var Join = document.getElementsByName("NewSourceJoin")[0];

		var newrow = table.insertRow(-1);
		var cell1 = newrow.insertCell(0) ;
		cell1.innerHTML=Model.value+'.'+Name.value ;

		var cell2 = newrow.insertCell(1);
		cell2.innerHTML=Desc.value ;

		var cell3 = newrow.insertCell(2);
		cell3.innerHTML=Join.value ;

		var keepcell = newrow.insertCell(-1) ;
		keepcell.setAttribute('class','w3-center');
		keepcell.id='src_'+Order;

		var keepcb = document.createElement('input');
		keepcb.setAttribute('type','checkbox');
		keepcb.checked = true ;
		keepcb.id = 'newsrc_'+Order ;
		keepcb.name = 'newsrc_'+Order ;
		keepcb.setAttribute('onchange','CheckBoxSource(this)');

		keepcell.appendChild(keepcb) ;
		CheckBoxSource(keepcb);

		Name.value = '' ;
		Desc.value = '' ;
		Join.value = '' ;

		Name.placeholder='Source Dataset Name' ;
		Desc.placeholder='Provide a description of the subset of the source data set (if any) (e.g excluding screen failures)';
		Join.placeholder='Provide a description of how the data sets are to be merged.';

	}

	function CheckBox(obj,CodedYN) {
		var hidect = document.getElementById('hideCT') ;
		// Get the parent <td> element
		var parenttd = obj.parentElement ;
		// Get the parent <tr> element
		var parenttr = parenttd.parentElement ;
		// Get all <td> elements
		var tdcoll = parenttr.children ;
		// Get the term 
		var term = tdcoll[0].innerHTML ;

		if (obj.checked == true) {
			var hideelement = document.createElement('input') ;
			hideelement.setAttribute('type','hidden') ;
			hideelement.setAttribute('name','newterm_'+term) ;
			if (CodedYN == 'Y') {
				var decode = tdcoll[1].innerHTML ;
				hideelement.setAttribute('value',decode) ;
			}
			hidect.appendChild(hideelement);
		}

		else {
			var rmv = document.getElementById('newterm_'+term) ;
			hideCT.removeChild(rmv) ;
		}
	}

	function CheckBoxSource(obj) {
		var hidesrc = document.getElementById('hidesrc') ;
		// Get the parent <td> element
		var parenttd = obj.parentElement ;
		// Get the parent <tr> element
		var parenttr = parenttd.parentElement ;
		// Get all <td> elements
		var tdcoll = parenttr.children ;
		// Get the term 
		var ds = tdcoll[0].innerHTML ;
		var desc = tdcoll[1].innerHTML;
		var join = tdcoll[2].innerHTML;

		if (obj.checked == true) {
			var hideds = document.createElement('input') ;
			hideds.type='hidden' ;
			hideds.name='newds_'+obj.id ;
			hideds.value=ds;
			hidesrc.appendChild(hideds);

			var hidedesc = document.createElement('input') ;
			hidedesc.type='hidden' ;
			hidedesc.name='newdesc_'+obj.id ;
			hidedesc.value=desc;
			hidesrc.appendChild(hidedesc);

			var hidejoin = document.createElement('input') ;
			hidejoin.type='hidden' ;
			hidejoin.name='newjoin_'+obj.id ;
			hidejoin.value=join;
			hidesrc.appendChild(hidejoin);
		}

		else {
			var rmv = document.getElementsByName('newds_'+obj.id) ;
			hidesrc.removeChild(rmv[0]) ;
			var rmv = document.getElementsByName('newdesc_'+obj.id);
			hidesrc.removeChild(rmv[0]);
			var rmv = document.getElementsByName('newjoin_'+obj.id);
			hidesrc.removeChild(rmv[0]);
		}
	}

	function test(parm) {
		alert('Hello World!  Parm='+parm);
	}

</script>








